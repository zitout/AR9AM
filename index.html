<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بحث رقم الملف من رقم الحساب - AI مدعوم</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 600px;
            width: 100%;
        }
        
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .ai-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-block;
            margin-bottom: 20px;
        }
        
        .input-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            color: #333;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 18px;
            text-align: center;
            transition: border-color 0.3s;
            direction: ltr;
        }
        
        input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-search {
            background: #667eea;
            color: white;
        }
        
        .btn-search:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-clear {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-clear:hover {
            background: #e0e0e0;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .camera-section {
            margin: 30px 0;
            padding: 25px;
            background: #f8f9ff;
            border-radius: 10px;
            border: 2px dashed #667eea;
        }
        
        .camera-label {
            display: block;
            text-align: center;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .camera-button {
            width: 100%;
            padding: 15px;
            background: #764ba2;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .camera-button:hover:not(:disabled) {
            background: #6a3f91;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(118, 75, 162, 0.4);
        }
        
        #imagePreview {
            margin-top: 15px;
            text-align: center;
            display: none;
        }
        
        #imagePreview img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .result {
            margin-top: 25px;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            display: none;
        }
        
        .result.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .result.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .result.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }
        
        .loading {
            text-align: center;
            margin-top: 20px;
            display: none;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 10px;
            color: #667eea;
            font-weight: bold;
        }
        
        .file-number {
            font-size: 36px;
            color: #667eea;
            margin: 10px 0;
        }
        
        .stats {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
            color: #666;
            font-size: 14px;
        }
        
        .api-setup {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .api-setup h3 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .api-setup p {
            color: #856404;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .api-setup a {
            color: #667eea;
            text-decoration: none;
            font-weight: bold;
        }
        
        .api-setup a:hover {
            text-decoration: underline;
        }
        
        .hide {
            display: none;
        }
        
        .info-note {
            background: #e7f3ff;
            border: 1px solid #2196F3;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #0d47a1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 بحث رقم الملف</h1>
        <div style="text-align: center;">
            <span class="ai-badge">🤖 مدعوم بـ Gemini 2.0 Flash AI</span>
        </div>
        <p class="subtitle">أدخل رقم الحساب أو التقط صورة للبحث بواسطة الذكاء الاصطناعي</p>
        
        <!-- قسم إعداد API Key -->
        <div class="api-setup" id="apiSetup">
            <h3>⚙️ الإعداد الأولي</h3>
            <p>لاستخدام ميزة الكاميرا مع AI، أدخل مفتاح API الخاص بـ Google Gemini:</p>
            <div class="input-group">
                <input type="password" id="apiKeyInput" placeholder="أدخل API Key هنا">
                <button class="btn-search" onclick="saveApiKey()" style="margin-top: 10px; width: 100%;">
                    💾 حفظ المفتاح
                </button>
            </div>
            <p style="font-size: 12px;">
                للحصول على API Key مجاني: 
                <a href="https://aistudio.google.com/app/apikey" target="_blank">
                    انقر هنا
                </a>
            </p>
        </div>
        
        <div class="info-note">
            ℹ️ ملاحظة: أرقام الحسابات تتراوح من 1 إلى 8 خانات
        </div>
        
        <div class="input-group">
            <label for="accountInput">رقم الحساب (من 1 إلى 8 خانات):</label>
            <input type="text" id="accountInput" placeholder="مثال: 9797922" maxlength="8">
        </div>
        
        <div class="button-group">
            <button class="btn-search" onclick="searchAccount()">🔍 بحث</button>
            <button class="btn-clear" onclick="clearFields()">🗑️ مسح</button>
        </div>
        
        <div class="camera-section">
            <label class="camera-label">📸 أو التقط صورة لرقم الحساب (AI سيكتشفه)</label>
            <input type="file" id="imageInput" accept="image/*" capture="environment" onchange="handleImageUpload()">
            <button class="camera-button" id="cameraBtn" onclick="document.getElementById('imageInput').click()">
                📷 فتح الكاميرا
            </button>
            <div id="imagePreview"></div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div class="loading-text">جاري المعالجة بواسطة AI...</div>
        </div>
        
        <div class="result" id="result"></div>
        
        <div class="stats">
            📊 عدد الحسابات في قاعدة البيانات: <span id="totalAccounts">---</span>
        </div>
    </div>

    <script>
        // تحميل بيانات الحسابات
        let accountData = {};
        let geminiApiKey = localStorage.getItem('geminiApiKey') || '';
        
        // إخفاء قسم API إذا كان المفتاح محفوظاً
        if (geminiApiKey) {
            document.getElementById('apiSetup').classList.add('hide');
        }
        
        // تحميل ملف JSON
        fetch('data.json')
            .then(response => response.json())
            .then(data => {
                accountData = data;
                document.getElementById('totalAccounts').textContent = Object.keys(accountData).length;
            })
            .catch(error => {
                console.error('خطأ في تحميل البيانات:', error);
                showResult('خطأ في تحميل قاعدة البيانات', 'error');
            });
        
        // حفظ API Key
        function saveApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) {
                alert('الرجاء إدخال API Key');
                return;
            }
            localStorage.setItem('geminiApiKey', apiKey);
            geminiApiKey = apiKey;
            document.getElementById('apiSetup').classList.add('hide');
            showResult('✅ تم حفظ API Key بنجاح! يمكنك الآن استخدام الكاميرا', 'success');
        }
        
        // البحث عن رقم الحساب
        function searchAccount() {
            const accountInput = document.getElementById('accountInput').value.trim();
            
            if (!accountInput) {
                showResult('⚠️ الرجاء إدخال رقم الحساب', 'error');
                return;
            }
            
            // التحقق من أن الإدخال أرقام فقط وطوله من 1-8
            if (!/^\\d+$/.test(accountInput) || accountInput.length > 8) {
                showResult('⚠️ رقم الحساب يجب أن يكون أرقام فقط (من 1 إلى 8 خانات)', 'error');
                return;
            }
            
            // البحث في البيانات
            const fileNumber = accountData[accountInput];
            
            if (fileNumber) {
                showResult(`✅ تم العثور على الملف<div class="file-number">رقم الملف: ${fileNumber}</div>رقم الحساب: ${accountInput}`, 'success');
            } else {
                showResult(`❌ لم يتم العثور على رقم الحساب: ${accountInput}`, 'error');
            }
        }
        
        // التعامل مع رفع الصورة
        function handleImageUpload() {
            const fileInput = document.getElementById('imageInput');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            if (!geminiApiKey) {
                showResult('⚠️ الرجاء إدخال API Key أولاً في قسم الإعداد', 'error');
                document.getElementById('apiSetup').classList.remove('hide');
                return;
            }
            
            // عرض الصورة
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('imagePreview');
                preview.innerHTML = '<img src="' + e.target.result + '" alt="معاينة الصورة">';
                preview.style.display = 'block';
                
                // بدء معالجة الصورة بواسطة AI
                processImageWithGemini(e.target.result);
            };
            reader.readAsDataURL(file);
        }
        
        // معالجة الصورة باستخدام Gemini AI
        async function processImageWithGemini(base64Image) {
            showLoading(true);
            hideResult();
            
            try {
                // إزالة بادئة data URL
                const base64Data = base64Image.split(',')[1];
                
                // إعداد الطلب
                const requestBody = {
                    contents: [{
                        parts: [
                            {
                                text: "هذه صورة تحتوي على رقم حساب. الرقم يمكن أن يكون من 1 إلى 8 خانات فقط. استخرج فقط الأرقام الموجودة في الصورة بدون أي نص إضافي. إذا وجدت أكثر من رقم، أعط الرقم الأكثر وضوحاً أو الأكبر حجماً في الصورة. أرجع الرقم فقط بدون أي تفسير أو نص إضافي."
                            },
                            {
                                inline_data: {
                                    mime_type: "image/jpeg",
                                    data: base64Data
                                }
                            }
                        ]
                    }]
                };
                
                // استدعاء Gemini API
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${geminiApiKey}`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody)
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                showLoading(false);
                
                // استخراج النص من الاستجابة
                const extractedText = data.candidates[0].content.parts[0].text.trim();
                
                // استخراج أي رقم من 1-8 خانات
                const numbers = extractedText.match(/\\d+/g);
                
                if (numbers && numbers.length > 0) {
                    // البحث عن أول رقم موجود في قاعدة البيانات
                    let foundAccount = null;
                    let foundFileNumber = null;
                    
                    for (let num of numbers) {
                        if (num.length <= 8 && accountData[num]) {
                            foundAccount = num;
                            foundFileNumber = accountData[num];
                            break;
                        }
                    }
                    
                    if (foundAccount) {
                        document.getElementById('accountInput').value = foundAccount;
                        showResult(`✅ AI اكتشف الرقم بنجاح!<div class="file-number">رقم الملف: ${foundFileNumber}</div>رقم الحساب المكتشف: ${foundAccount}`, 'success');
                    } else {
                        // جرب أول رقم مكتشف
                        const accountNum = numbers[0];
                        if (accountNum.length <= 8) {
                            document.getElementById('accountInput').value = accountNum;
                            showResult(`⚠️ AI اكتشف الرقم: ${accountNum}<br>لكن لم يتم العثور عليه في قاعدة البيانات`, 'error');
                        } else {
                            showResult(`⚠️ الرقم المكتشف (${accountNum}) أطول من 8 خانات`, 'error');
                        }
                    }
                } else {
                    showResult('❌ لم يستطع AI اكتشاف أرقام في الصورة<br>النص المكتشف: ' + extractedText, 'error');
                }
                
            } catch (error) {
                showLoading(false);
                console.error('خطأ في معالجة الصورة:', error);
                
                if (error.message.includes('API Error: 400')) {
                    showResult('❌ خطأ في API Key. تأكد من صحة المفتاح<br><button onclick="document.getElementById(\'apiSetup\').classList.remove(\'hide\')" style="margin-top: 10px; padding: 10px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">تعديل API Key</button>', 'error');
                } else {
                    showResult('❌ حدث خطأ أثناء معالجة الصورة<br>الرجاء المحاولة مرة أخرى', 'error');
                }
            }
        }
        
        // مسح الحقول
        function clearFields() {
            document.getElementById('accountInput').value = '';
            document.getElementById('imageInput').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('imagePreview').innerHTML = '';
            hideResult();
        }
        
        // عرض النتيجة
        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = message;
            resultDiv.className = 'result ' + type;
            resultDiv.style.display = 'block';
        }
        
        // إخفاء النتيجة
        function hideResult() {
            document.getElementById('result').style.display = 'none';
        }
        
        // عرض/إخفاء شاشة التحميل
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        // السماح بالبحث عند الضغط على Enter
        document.getElementById('accountInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchAccount();
            }
        });
        
        // التحقق من إدخال أرقام فقط
        document.getElementById('accountInput').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
    </script>
</body>
</html>
