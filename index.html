<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بحث رقم الملف - بسيط وسريع</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 500px;
            width: 100%;
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .camera-section {
            margin-bottom: 25px;
        }

        .camera-btn {
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .camera-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6);
        }

        .camera-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .image-preview {
            display: none;
            margin-top: 15px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            position: relative;
        }

        .image-preview img {
            width: 100%;
            height: auto;
            display: block;
        }

        .image-size-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-weight: bold;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .input-display {
            width: 100%;
            padding: 20px;
            border: 3px solid #667eea;
            border-radius: 15px;
            font-size: 32px;
            text-align: center;
            margin-bottom: 20px;
            background: #f8f9ff;
            color: #333;
            font-weight: bold;
            direction: ltr;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .num-btn {
            padding: 25px;
            font-size: 28px;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            background: #667eea;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }

        .num-btn:hover {
            background: #5568d3;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
        }

        .num-btn:active {
            transform: translateY(0);
        }

        .control-btn {
            padding: 20px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .delete-btn {
            background: #ffa726;
            color: white;
        }

        .delete-btn:hover {
            background: #ff9800;
            transform: translateY(-2px);
        }

        .clear-btn {
            background: #ff6b6b;
            color: white;
        }

        .clear-btn:hover {
            background: #ff5252;
            transform: translateY(-2px);
        }

        .result {
            margin-top: 25px;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .result.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .result.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }

        .result.empty {
            background: #f8f9ff;
            color: #999;
            border: 2px solid #e0e0e0;
        }

        .result.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .file-number {
            font-size: 48px;
            color: #667eea;
            margin: 15px 0;
        }

        .stats {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
            color: #666;
            font-size: 14px;
        }

        .tips {
            background: #d4edda;
            border: 1px solid #28a745;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #155724;
            text-align: center;
        }

        .auto-search-note {
            text-align: center;
            color: #667eea;
            font-size: 12px;
            margin-bottom: 15px;
            font-style: italic;
        }

        #imageInput {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 بحث رقم الملف</h1>
        <p class="subtitle">صوّر رقم الحساب أو اكتبه يدوياً</p>

        <div class="tips">
            ⚡ البحث التلقائي + ضغط ذكي للصور
        </div>

        <div class="camera-section">
            <input type="file" id="imageInput" accept="image/*" capture="environment">
            <button class="camera-btn" onclick="openCamera()">
                📸 صوّر رقم الحساب
            </button>
            
            <div class="image-preview" id="imagePreview">
                <img id="previewImg" src="" alt="معاينة">
                <div class="image-size-info" id="sizeInfo"></div>
            </div>

            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <p>جاري ضغط الصورة واستخراج الرقم...</p>
            </div>
        </div>

        <div class="input-display" id="display">
            <span id="displayText" style="color: #999;">اضغط على الأرقام</span>
        </div>

        <div class="auto-search-note">
            📝 اكتب رقم الحساب (من 2 إلى 10 أرقام)
        </div>

        <div class="numpad">
            <button class="num-btn" onclick="addNumber('1')">1</button>
            <button class="num-btn" onclick="addNumber('2')">2</button>
            <button class="num-btn" onclick="addNumber('3')">3</button>
            <button class="num-btn" onclick="addNumber('4')">4</button>
            <button class="num-btn" onclick="addNumber('5')">5</button>
            <button class="num-btn" onclick="addNumber('6')">6</button>
            <button class="num-btn" onclick="addNumber('7')">7</button>
            <button class="num-btn" onclick="addNumber('8')">8</button>
            <button class="num-btn" onclick="addNumber('9')">9</button>
            <button class="control-btn delete-btn" onclick="deleteLastDigit()">⌫ حذف</button>
            <button class="num-btn" onclick="addNumber('0')">0</button>
            <button class="control-btn clear-btn" onclick="clearInput()">🗑️ مسح</button>
        </div>

        <div class="result empty" id="result">
            <span>النتيجة ستظهر هنا</span>
        </div>

        <div class="stats">
            📊 عدد الحسابات: <span id="totalAccounts">---</span>
        </div>
    </div>

    <script>
        // ⚙️ ضع مفتاح Gemini API الخاص بك هنا
        const GEMINI_API_KEY = 'AIzaSyA8aQNXrGIzy4iJsoBYUzRU9X7n33pbRbs';
        const GEMINI_MODEL = 'gemini-2.0-flash';

        // إعدادات الضغط
        const COMPRESSION_CONFIG = {
            maxWidth: 1024,
            maxHeight: 1024,
            quality: 0.6,
            targetSizeKB: 100
        };

        let accountData = {};
        let currentInput = '';
        let dataLoaded = false;
        let dataLoadingPromise = null;

        // ✅ تحميل ملف JSON مع ضمان جاهزيته (محسّن)
        async function loadAccountData() {
            // إذا كانت البيانات محملة بالفعل، لا نحمّلها مرة أخرى
            if (dataLoaded && Object.keys(accountData).length > 0) {
                return;
            }

            // إذا كان التحميل جارياً، ننتظر انتهاءه
            if (dataLoadingPromise) {
                return dataLoadingPromise;
            }

            // بدء التحميل
            dataLoadingPromise = (async () => {
                try {
                    const response = await fetch('data.json');
                    accountData = await response.json();
                    dataLoaded = true;
                    document.getElementById('totalAccounts').textContent = Object.keys(accountData).length;
                    console.log('✅ تم تحميل قاعدة البيانات:', Object.keys(accountData).length, 'حساب');
                } catch (error) {
                    console.error('❌ خطأ في تحميل البيانات:', error);
                    showResult('خطأ في تحميل قاعدة البيانات', 'error');
                    dataLoaded = false;
                }
            })();

            return dataLoadingPromise;
        }

        // تحميل البيانات عند بدء الصفحة
        loadAccountData();

        function openCamera() {
            document.getElementById('imageInput').click();
        }

        document.getElementById('imageInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const originalSizeKB = (file.size / 1024).toFixed(2);
            console.log(`الحجم الأصلي: ${originalSizeKB} KB`);

            // عرض معاينة الصورة
            const reader = new FileReader();
            reader.onload = function(event) {
                const preview = document.getElementById('imagePreview');
                const previewImg = document.getElementById('previewImg');
                previewImg.src = event.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);

            // ضغط ومعالجة
            await compressAndProcess(file, originalSizeKB);
        });

        async function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const img = new Image();
                    
                    img.onload = function() {
                        let width = img.width;
                        let height = img.height;
                        
                        const ratio = Math.min(
                            COMPRESSION_CONFIG.maxWidth / width,
                            COMPRESSION_CONFIG.maxHeight / height,
                            1
                        );
                        
                        width = Math.floor(width * ratio);
                        height = Math.floor(height * ratio);
                        
                        console.log(`الأبعاد الجديدة: ${width}x${height}`);
                        
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        canvas.toBlob(
                            (blob) => {
                                if (blob) {
                                    const compressedSizeKB = (blob.size / 1024).toFixed(2);
                                    console.log(`الحجم بعد الضغط: ${compressedSizeKB} KB`);
                                    
                                    if (blob.size / 1024 > COMPRESSION_CONFIG.targetSizeKB) {
                                        canvas.toBlob(
                                            (blob2) => resolve(blob2),
                                            'image/jpeg',
                                            0.4
                                        );
                                    } else {
                                        resolve(blob);
                                    }
                                } else {
                                    reject(new Error('فشل ضغط الصورة'));
                                }
                            },
                            'image/jpeg',
                            COMPRESSION_CONFIG.quality
                        );
                    };
                    
                    img.onerror = () => reject(new Error('فشل تحميل الصورة'));
                    img.src = e.target.result;
                };
                
                reader.onerror = () => reject(new Error('فشل قراءة الملف'));
                reader.readAsDataURL(file);
            });
        }

        async function compressAndProcess(file, originalSizeKB) {
            const loading = document.getElementById('loading');
            const cameraBtn = document.querySelector('.camera-btn');
            const sizeInfo = document.getElementById('sizeInfo');
            
            loading.style.display = 'block';
            cameraBtn.disabled = true;

            try {
                // ✅ التأكد من تحميل البيانات في الخلفية
                loadAccountData();

                sizeInfo.textContent = `الأصلي: ${originalSizeKB} KB - جاري الضغط...`;
                const compressedBlob = await compressImage(file);
                const compressedSizeKB = (compressedBlob.size / 1024).toFixed(2);
                
                sizeInfo.textContent = `الأصلي: ${originalSizeKB} KB → المضغوط: ${compressedSizeKB} KB ✅`;
                
                const base64Image = await blobToBase64(compressedBlob);
                const imageData = base64Image.split(',')[1];
                
                await sendToGemini(imageData, compressedBlob.type);
                
            } catch (error) {
                console.error('خطأ:', error);
                showResult('❌ حدث خطأ أثناء المعالجة', 'error');
            } finally {
                loading.style.display = 'none';
                cameraBtn.disabled = false;
            }
        }

        // ✅ دالة محسّنة مع ضمان تحميل البيانات قبل البحث
        async function sendToGemini(imageData, mimeType) {
            try {
                const prompt = `استخرج رقم الحساب من هذه الصورة. الرقم مكون من 10 أرقام بالضبط (مثال: 0001234567 أو 0000023568 أو 0125895423).

قواعد الاستخراج:
1. ابحث عن رقم مكون من 10 أرقام بالضبط
2. أرجع الرقم فقط بدون أي نص إضافي
3. إذا كان الرقم يبدأ بأصفار، احتفظ بها
4. إذا لم تجد رقماً صحيحاً، أرجع "ERROR"

أرجع الرقم فقط:`;

                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: prompt },
                                    {
                                        inline_data: {
                                            mime_type: mimeType,
                                            data: imageData
                                        }
                                    }
                                ]
                            }],
                            generationConfig: {
                                temperature: 0.1,
                                maxOutputTokens: 100,
                            }
                        })
                    }
                );

                const result = await response.json();
                
                if (result.candidates && result.candidates[0]) {
                    const extractedText = result.candidates[0].content.parts[0].text.trim();
                    console.log('📄 نص مستخرج:', extractedText);
                    
                    const accountNumber = extractNumber(extractedText);
                    
                    if (accountNumber) {
                        const cleanedNumber = accountNumber.replace(/^0+/, '') || '0';
                        console.log('🔢 الرقم المنقح:', cleanedNumber);
                        
                        // ✅ تحديث الإدخال
                        currentInput = cleanedNumber;
                        updateDisplay();
                        
                        // ✅ انتظار تحميل البيانات قبل البحث
                        console.log('⏳ التأكد من تحميل البيانات...');
                        await loadAccountData();
                        
                        // ✅ البحث الفوري بعد التأكد من التحميل
                        console.log('🔍 بدء البحث...');
                        performSearch(cleanedNumber);
                        
                    } else {
                        showResult('❌ لم يتم العثور على رقم صحيح في الصورة', 'error');
                    }
                } else {
                    throw new Error('فشل في الحصول على استجابة من Gemini');
                }

            } catch (error) {
                console.error('خطأ في API:', error);
                showResult('❌ حدث خطأ في الاتصال بالذكاء الاصطناعي', 'error');
            }
        }

        // ✅ دالة بحث مستقلة ومحسّنة
        function performSearch(accountNumber) {
            console.log('🔍 البحث عن رقم:', accountNumber);
            console.log('📊 قاعدة البيانات جاهزة:', dataLoaded);
            console.log('📦 عدد الحسابات:', Object.keys(accountData).length);
            
            if (!dataLoaded || Object.keys(accountData).length === 0) {
                showResult('⏳ جاري تحميل قاعدة البيانات...', 'info');
                // إعادة المحاولة بعد ثانية
                setTimeout(() => performSearch(accountNumber), 1000);
                return;
            }

            const fileNumber = accountData[accountNumber];
            console.log('📁 نتيجة البحث:', fileNumber);

            if (fileNumber) {
                showResult(
                    `✅ تم العثور على الملف<div class="file-number">رقم الملف: ${fileNumber}</div>رقم الحساب: ${accountNumber}`,
                    'success'
                );
            } else {
                showResult(
                    `🔍 البحث عن: ${accountNumber}<br><small>❌ لم يتم العثور على هذا الرقم</small>`,
                    'info'
                );
            }
        }

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        function extractNumber(text) {
            const match = text.match(/\b\d{10}\b/);
            return match ? match[0] : null;
        }

        function addNumber(num) {
            if (currentInput.length >= 10) return;
            currentInput += num;
            updateDisplay();
            autoSearch();
        }

        function deleteLastDigit() {
            currentInput = currentInput.slice(0, -1);
            updateDisplay();
            autoSearch();
        }

        function clearInput() {
            currentInput = '';
            updateDisplay();
            showResult('النتيجة ستظهر هنا', 'empty');
            document.getElementById('imagePreview').style.display = 'none';
        }

        function updateDisplay() {
            const displayText = document.getElementById('displayText');
            if (currentInput.length === 0) {
                displayText.textContent = 'اضغط على الأرقام';
                displayText.style.color = '#999';
            } else {
                displayText.textContent = currentInput;
                displayText.style.color = '#333';
            }
        }

        function autoSearch() {
            if (currentInput.length < 2) {
                if (currentInput.length === 0) {
                    showResult('النتيجة ستظهر هنا', 'empty');
                } else {
                    showResult('اكتب رقمين على الأقل', 'empty');
                }
                return;
            }

            // ✅ استخدام دالة البحث المحسّنة
            performSearch(currentInput);
        }

        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = message;
            resultDiv.className = 'result ' + type;
        }

        document.addEventListener('keydown', function(e) {
            if (e.key >= '0' && e.key <= '9') {
                addNumber(e.key);
            } else if (e.key === 'Backspace') {
                e.preventDefault();
                deleteLastDigit();
            } else if (e.key === 'Delete' || e.key === 'Escape') {
                clearInput();
            }
        });
    </script>
</body>
</html>
